#!/usr/bin/env bash

set -euo pipefail

PROJECT_FOLDER=`realpath $(dirname "$0")/..`

if [ -z ${DATA_FOLDER+x} ]; then
  DATA_FOLDER="$PROJECT_FOLDER"/data
fi

mkdir -p "$DATA_FOLDER"

if [ -z ${ARQUIVO_PORT+x} ]; then
  ARQUIVO_PORT=12347
fi

if [ "$#" -eq 0 ]; then
  echo "Usage: $0 mawl [input-folder] [output-folder]"
  exit 1
else
  if [ "$1" = "build" ]; then
    shift
    MAWL_INPUT_PATH=`realpath "$1"`

    if [ -z "${2+x}" ]; then
      MAWL_OUTPUT_PATH="$PROJECT_FOLDER"/tmp/mawl-output
    else
      MAWL_OUTPUT_PATH="$2"
    fi

    export STATIC_PLS=1
    DOCKER_COMMAND=/arquivo/bin/mawl-import-and-generate
  elif [ "$1" = "server" ]; then
    shift
    MAWL_INPUT_PATH=`realpath "$1"`

    if [ -z "${2+x}" ]; then
      MAWL_OUTPUT_PATH="$PROJECT_FOLDER"/tmp/mawl-output
    else
      MAWL_OUTPUT_PATH="$2"
    fi

    export STATIC_PLS=1
    DOCKER_COMMAND=
  elif [ "$1" = "console" ]; then
    shift
    MAWL_INPUT_PATH=`realpath "$1"`

    if [ -z "${2+x}" ]; then
      MAWL_OUTPUT_PATH="$PROJECT_FOLDER"/tmp/mawl-output
    else
      MAWL_OUTPUT_PATH="$2"
    fi

    export STATIC_PLS=1
    DOCKER_COMMAND=bash
  fi

fi

export ARQUIVO_USER=phillmv
export ARQUIVO_GIT_EMAIL=phillmv@okayfail.com
export ARQUIVO_GIT_NAME="Phill MV"
export RAILS_BIND=tcp://0.0.0.0:3001
export RAILS_ENV=development

echo "Running mawl while mounting local filesystem..."

docker run -it -p "$ARQUIVO_PORT":3001 \
  -e ARQUIVO_USER \
  -e ARQUIVO_GIT_EMAIL \
  -e ARQUIVO_GIT_NAME \
  -e RAILS_ENV \
  -e RAILS_BIND \
  -e STATIC_PLS \
  -v "$DATA_FOLDER":/data \
  -v "$MAWL_INPUT_PATH":/mawl-input \
  -v "$MAWL_OUTPUT_PATH":/output \
  -v "$PROJECT_FOLDER":/arquivo \
  ghcr.io/phillmv/arquivo-development:latest ${DOCKER_COMMAND}
